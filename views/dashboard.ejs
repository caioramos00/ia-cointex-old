<!-- Updated dashboard.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <title>Dashboard Bot WhatsApp</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container mt-5">
  <h1>Dashboard de Fluxo de Conversas</h1>

  <!-- Filtros -->
  <form action="/dashboard" method="GET" class="mb-4">
    <div class="row">
      <div class="col-md-3"><label>Data Início:</label><input type="date" name="start" value="<%= start || '' %>" class="form-control"></div>
      <div class="col-md-3"><label>Data Fim:</label><input type="date" name="end" value="<%= end || '' %>" class="form-control"></div>
      <div class="col-md-3"><label>Etapa:</label><select name="etapa" class="form-control"><option value="">Todas</option><% etapasDisponiveis.forEach(e => { %><option <%= etapa === e ? 'selected' : '' %>><%= e %></option><% }) %></select></div>
      <div class="col-md-3 mt-4"><button type="submit" class="btn btn-primary">Filtrar</button></div>
    </div>
  </form>

  <!-- Métricas -->
  <div class="row mb-4">
    <div class="col-md-3"><div class="card p-3"><h5>Conversas Iniciadas</h5><p id="iniciadas"><%= metricas.iniciadas %></p></div></div>
    <div class="col-md-3"><div class="card p-3"><h5>Finalizadas</h5><p id="finalizadas"><%= metricas.finalizadas %></p></div></div>
    <div class="col-md-3"><div class="card p-3"><h5>Não Finalizadas</h5><p id="naoFinalizadas"><%= metricas.naoFinalizadas %></p></div></div>
    <div class="col-md-3"><div class="card p-3"><h5>Taxa de Conversão</h5><p id="taxaConversao"><%= metricas.taxaConversao %>%</p></div></div>
  </div>

  <!-- Gráficos -->
  <div class="row mb-4">
    <div class="col-md-6">
      <h5>Funil de Etapas</h5>
      <canvas id="etapasChart"></canvas>
    </div>
    <div class="col-md-6">
      <h5>Conversas por Dia</h5>
      <canvas id="porDiaChart"></canvas>
    </div>
  </div>

  <!-- Lista de Contatos -->
  <h2>Lista de Contatos Filtrados (<span id="numContatos"><%= metricas.filtrados.length %></span>)</h2>
  <table class="table table-striped" id="contatosTable">
    <thead><tr><th>ID</th><th>Etapa</th><th>Última Interação</th><th>Progresso</th><th>Ações</th></tr></thead>
    <tbody>
      <% metricas.filtrados.forEach(c => { %>
        <tr>
          <td><%= c.id %></td>
          <td><%= c.etapa_atual %></td>
          <td><%= new Date(c.ultimaInteracao).toLocaleString() %></td>
          <td><%= ((Object.keys(metricas.etapas).indexOf(c.etapa_atual) / 7) * 100).toFixed(0) %>%</td> <!-- Ajuste para suas etapas -->
          <td><a href="/dashboard/contact/<%= c.id %>" class="btn btn-primary btn-sm">Ver</a></td>
        </tr>
      <% }) %>
    </tbody>
  </table>

  <!-- Botão Exportar -->
  <a href="/dashboard/export" class="btn btn-success mb-3">Exportar CSV</a>

  <!-- Logs -->
  <h2>Logs em Tempo Real</h2>
  <div id="logs" class="border p-3" style="height: 300px; overflow-y: scroll;"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.on('log', (msg) => {
      const logDiv = document.getElementById('logs');
      logDiv.innerHTML += `<p>${msg}</p>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    });

    socket.on('update_metrics', (metricas) => {
      document.getElementById('iniciadas').textContent = metricas.iniciadas;
      document.getElementById('finalizadas').textContent = metricas.finalizadas;
      document.getElementById('naoFinalizadas').textContent = metricas.naoFinalizadas;
      document.getElementById('taxaConversao').textContent = metricas.taxaConversao + '%';
      document.getElementById('numContatos').textContent = metricas.filtrados.length;

      // Update charts
      etapasChart.data.labels = Object.keys(metricas.etapas);
      etapasChart.data.datasets[0].data = Object.values(metricas.etapas);
      etapasChart.update();

      porDiaChart.data.labels = Object.keys(metricas.conversasPorDia);
      porDiaChart.data.datasets[0].data = Object.values(metricas.conversasPorDia);
      porDiaChart.update();

      // For table, perhaps reload or append; for simplicity, we'll not update table dynamically here
    });

    // Gráfico Funil Etapas
    const etapasCtx = document.getElementById('etapasChart').getContext('2d');
    const etapasLabels = <%= JSON.stringify(etapasDisponiveis) %>;
    const etapasData = etapasLabels.map(e => <%- JSON.stringify(metricas.etapas) %>[e] || 0);
    const etapasChart = new Chart(etapasCtx, {
      type: 'bar',
      data: { labels: etapasLabels, datasets: [{ label: 'Contatos por Etapa', data: etapasData, backgroundColor: 'rgba(75, 192, 192, 0.2)' }] },
      options: { scales: { y: { beginAtZero: true } } }
    });

    // Gráfico por Dia
    const porDiaCtx = document.getElementById('porDiaChart').getContext('2d');
    const porDiaChart = new Chart(porDiaCtx, {
      type: 'line',
      data: { labels: Object.keys(<%- JSON.stringify(metricas.conversasPorDia) %>), datasets: [{ label: 'Conversas por Dia', data: Object.values(<%- JSON.stringify(metricas.conversasPorDia) %>), borderColor: 'rgba(153, 102, 255, 1)' }] },
      options: { scales: { y: { beginAtZero: true } } }
    });
  </script>
</body>
</html>