<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <title>Admin • Configurações do Bot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="container py-4">
    <h1 class="mb-3">Configurações do Bot</h1>

    <% if (ok) { %>
        <div class="alert alert-success">Configurações salvas com sucesso.</div>
        <% } %>

            <form method="POST" action="/admin/settings" class="row g-3">
                <div class="col-12 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="identity_enabled" name="identity_enabled"
                        <%=settings?.identity_enabled ? 'checked' : '' %> />
                    <label class="form-check-label" for="identity_enabled">Ativar selo de identidade na 1ª
                        resposta</label>
                </div>

                <div class="col-12">
                    <label class="form-label">Texto do selo (linha única ou curta)</label>
                    <input type="text" class="form-control" name="identity_label"
                        value="<%= settings?.identity_label || '' %>"
                        placeholder="Ex.: ACME • suporte: suporte@acme.com | acme.com/suporte">
                    <div class="form-text">Se vazio, tentaremos montar com e-mail/telefone/site abaixo.</div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">E-mail de suporte</label>
                    <input type="email" class="form-control" name="support_email"
                        value="<%= settings?.support_email || '' %>">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Telefone</label>
                    <input type="text" class="form-control" name="support_phone"
                        value="<%= settings?.support_phone || '' %>">
                </div>
                <div class="col-md-4">
                    <label class="form-label">URL (suporte)</label>
                    <input type="url" class="form-control" name="support_url"
                        value="<%= settings?.support_url || '' %>">
                </div>
                <hr class="my-3" />

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="optout_hint_enabled" name="optout_hint_enabled"
                        <%=(settings?.optout_hint_enabled ?? true) ? 'checked' : '' %> />
                    <label class="form-check-label" for="optout_hint_enabled">Mostrar dica de opt-out na 1ª resposta
                        (anexa na 3ª linha)</label>
                </div>

                <div class="mb-3">
                    <label class="form-label">Texto do sufixo de opt-out</label>
                    <input type="text" class="form-control" name="optout_suffix"
                        value="<%= settings?.optout_suffix || '· se não quiser: NÃO QUERO' %>" />
                    <div class="form-text">Ex.: <code>· se não quiser: NÃO QUERO</code>. Será anexado no fim da 3ª linha
                        do primeiro pacote.</div>
                </div>

                <label>Provedor de Mensagens</label>
                <select name="message_provider">
                    <option value="meta" <%=settings.message_provider==='meta' ? 'selected' : '' %>>Meta (direto)</option>
                    <option value="twilio" <%=settings.message_provider==='twilio' ? 'selected' : '' %>>Twilio</option>
                    <option value="manychat" <%=settings.message_provider==='manychat' ? 'selected' : '' %>>Manychat</option>
                </select>

                <!-- Campos Twilio -->
                <div id="twilio-settings" style="display: none;">
                    <input name="twilio_account_sid" value="<%= settings.twilio_account_sid || '' %>"
                        placeholder="TWILIO_ACCOUNT_SID" />
                    <input name="twilio_auth_token" value="<%= settings.twilio_auth_token || '' %>"
                        placeholder="TWILIO_AUTH_TOKEN" />
                    <input name="twilio_messaging_service_sid" value="<%= settings.twilio_messaging_service_sid || '' %>"
                        placeholder="TWILIO_MESSAGING_SERVICE_SID (opcional)" />
                    <input name="twilio_from" value="<%= settings.twilio_from || '' %>"
                        placeholder="TWILIO_FROM (whatsapp:+... se não usar service)" />
                </div>

                <!-- Campos Manychat -->
                <div id="manychat-settings" style="display: none;">
                    <input name="manychat_api_token" value="<%= settings.manychat_api_token || '' %>"
                        placeholder="MANYCHAT_API_TOKEN" />
                    <input name="manychat_fallback_flow_id" value="<%= settings.manychat_fallback_flow_id || '' %>"
                        placeholder="MANYCHAT_FALLBACK_FLOW_ID (flow com template)" />
                        <input name="manychat_webhook_secret" value="<%= settings.manychat_webhook_secret || '' %>" placeholder="MANYCHAT_WEBHOOK_SECRET" />
                </div>

                <!-- Campos Meta -->
                <div id="meta-settings" style="display: none;">
                    <h3 class="mt-3">Configurações Meta (WhatsApp Cloud API)</h3>

                    <div class="mb-3">
                        <label class="form-label">Access Token padrão (fallback)</label>
                        <input type="text" class="form-control" name="meta_access_token"
                               value="<%= settings.meta_access_token || '' %>">
                        <div class="form-text">
                            Usado apenas como fallback se nenhum número abaixo for compatível.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Phone Number ID padrão (fallback)</label>
                        <input type="text" class="form-control" name="meta_phone_number_id"
                               value="<%= settings.meta_phone_number_id || '' %>">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Contact Token (CAPI / Landing)</label>
                        <input type="text" class="form-control" name="contact_token"
                               value="<%= settings.contact_token || '' %>">
                    </div>

                    <hr class="my-3" />

                    <h4>Números WhatsApp Cloud cadastrados</h4>
                    <p class="text-muted small mb-2">
                        O bot responde sempre pelo mesmo número que recebeu a mensagem
                        (baseado no <code>phone_number_id</code> que chega no webhook).
                    </p>

                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Phone Number ID</th>
                                <th>Display Phone</th>
                                <th>Access Token</th>
                                <th>Ativo?</th>
                                <th style="width: 140px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <% const metaList = (typeof metaNumbers !== 'undefined' && metaNumbers) ? metaNumbers : []; %>
                            <% if (metaList.length) { %>
                                <% metaList.forEach(function (n) { %>
                                    <tr>
                                        <form method="post" action="/admin/settings/meta/save">
                                            <td>
                                                <input type="hidden" name="id" value="<%= n.id %>">
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       name="label"
                                                       value="<%= n.label || '' %>">
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       name="phone_number_id"
                                                       value="<%= n.phone_number_id || '' %>"
                                                       required>
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       name="display_phone_number"
                                                       value="<%= n.display_phone_number || '' %>">
                                            </td>
                                            <td>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       name="access_token"
                                                       value="<%= n.access_token || '' %>"
                                                       required>
                                            </td>
                                            <td class="text-center">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       name="active"
                                                       <%= n.active ? 'checked' : '' %> />
                                            </td>
                                            <td class="text-end">
                                                <button type="submit"
                                                        class="btn btn-sm btn-primary me-1">
                                                    Salvar
                                                </button>
                                                <button type="submit"
                                                        class="btn btn-sm btn-outline-danger"
                                                        formaction="/admin/settings/meta/delete"
                                                        onclick="return confirm('Remover este número?');">
                                                    Remover
                                                </button>
                                            </td>
                                        </form>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="text-muted">
                                        Nenhum número cadastrado ainda.
                                    </td>
                                </tr>
                            <% } %>

                            <!-- Linha para novo número -->
                            <tr>
                                <form method="post" action="/admin/settings/meta/save">
                                    <td>
                                        <input type="hidden" name="id" value="">
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               name="label"
                                               placeholder="Ex: Número principal">
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               name="phone_number_id"
                                               placeholder="phone_number_id"
                                               required>
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               name="display_phone_number"
                                               placeholder="Ex: +55 11 9XXXX-XXXX">
                                    </td>
                                    <td>
                                        <input type="text"
                                               class="form-control form-control-sm"
                                               name="access_token"
                                               placeholder="Access Token"
                                               required>
                                    </td>
                                    <td class="text-center">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="active"
                                               checked />
                                    </td>
                                    <td class="text-end">
                                        <button type="submit"
                                                class="btn btn-sm btn-success">
                                            Adicionar
                                        </button>
                                    </td>
                                </form>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="col-12">
                    <button class="btn btn-primary">Salvar</button>
                    <a class="btn btn-outline-secondary" href="/dashboard">Voltar ao Dashboard</a>
                </div>
            </form>

            <hr class="my-4" />

            <p class="text-muted mb-0">
                O selo é enviado <strong>apenas na primeira resposta</strong> de cada sessão para o contato, conforme as
                políticas da Meta.
            </p>

    <script>
        const providerSelect = document.querySelector('select[name="message_provider"]');
        const twilioDiv = document.getElementById('twilio-settings');
        const manychatDiv = document.getElementById('manychat-settings');
        const metaDiv = document.getElementById('meta-settings');

        function toggleProviderSettings() {
            const val = providerSelect.value.toLowerCase();
            twilioDiv.style.display = val === 'twilio' ? 'block' : 'none';
            manychatDiv.style.display = val === 'manychat' ? 'block' : 'none';
            metaDiv.style.display = val === 'meta' ? 'block' : 'none';
        }

        providerSelect.addEventListener('change', toggleProviderSettings);
        toggleProviderSettings(); // Inicial
    </script>
</body>

</html>